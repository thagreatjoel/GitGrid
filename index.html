<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GitHub Contributions</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #fff;
      color: #333;
    }

    h1 {
      text-align: center;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    input {
      padding: 0.5rem;
      font-size: 14px;
    }

    #graphContainer {
      display: none; /* hide until data is loaded */
    }

    .calendar {
      display: flex;
      gap: 4px;
      margin: auto;
      overflow-x: auto;
      width: fit-content;
    }

    .week {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .day {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      background-color: #ebedf0;
    }

    .level-1 { background-color: #ebedf0; }
    .level-2 { background-color: rgba(22, 160, 133, 0.3); }
    .level-3 { background-color: rgba(22, 160, 133, 0.5); }
    .level-4 { background-color: rgba(22, 160, 133, 0.7); }
    .level-5 { background-color: rgba(22, 160, 133, 1); }

    .month-labels {
      display: flex;
      gap: 4px;
      margin-left: 40px;
      margin-bottom: 4px;
      font-size: 12px;
      color: #555;
    }

    .month-labels span {
      width: 12px;
      text-align: center;
    }

    .day-labels {
      display: flex;
      flex-direction: column;
      font-size: 10px;
      gap: 16px;
      margin-top: 12px;
      margin-right: 6px;
      float: left;
    }

    #loading {
      text-align: center;
      font-size: 16px;
      margin-top: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>GitHub Contributions (Real Data)</h1>

  <div class="controls">
    <input id="userInput" type="text" value="" placeholder="GitHub Username" disabled />
  </div>

  <div id="loading">Loading contribution chart...</div>

  <div id="graphContainer">
    <div class="day-labels">
      <div>Sun</div>
      <div>Tue</div>
      <div>Thu</div>
      <div>Sat</div>
    </div>

    <div>
      <div class="month-labels" id="monthLabels"></div>
      <div class="calendar" id="calendar"></div>
    </div>
  </div>

  <script>
    const token = "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";
    const username = "__USERNAME__"; // Injected by server.js

    function getLevel(count) {
      if (count === 0) return 1;
      else if (count < 5) return 2;
      else if (count < 10) return 3;
      else if (count < 20) return 4;
      else return 5;
    }

    async function loadChart() {
      const calendar = document.getElementById("calendar");
      const monthLabels = document.getElementById("monthLabels");
      const input = document.getElementById("userInput");

      if (!token) return alert("GitHub token required!");

      input.value = username;
      calendar.innerHTML = "";
      monthLabels.innerHTML = "";

      const query = `
        {
          user(login: "${username}") {
            contributionsCollection {
              contributionCalendar {
                weeks {
                  contributionDays {
                    date
                    contributionCount
                  }
                }
              }
            }
          }
        }
      `;

      try {
        const res = await fetch("https://api.github.com/graphql", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "bearer " + token
          },
          body: JSON.stringify({ query })
        });

        const json = await res.json();

        if (!json?.data?.user) {
          calendar.innerHTML = `<h3>User not found: ${username}</h3>`;
          return;
        }

        const weeks = json.data.user.contributionsCollection.contributionCalendar.weeks;
        let prevMonth = "";

        weeks.forEach(week => {
          const weekCol = document.createElement("div");
          weekCol.className = "week";

          week.contributionDays.forEach(day => {
            const count = day.contributionCount;
            const level = getLevel(count);
            const div = document.createElement("div");
            div.className = `day level-${level}`;
            div.title = `${day.date}: ${count} contributions`;
            weekCol.appendChild(div);
          });

          const firstDay = week.contributionDays[0];
          const date = new Date(firstDay.date);
          const month = date.toLocaleString('default', { month: 'short' });

          if (month !== prevMonth) {
            const label = document.createElement("span");
            label.textContent = month;
            label.style.minWidth = "16px";
            monthLabels.appendChild(label);
            prevMonth = month;
          } else {
            const spacer = document.createElement("span");
            spacer.textContent = "";
            monthLabels.appendChild(spacer);
          }

          calendar.appendChild(weekCol);
        });

        // Now show the graph and hide the loading
        document.getElementById("loading").style.display = "none";
        document.getElementById("graphContainer").style.display = "block";

      } catch (err) {
        calendar.innerHTML = `<h3>Error loading data</h3><pre>${err.message}</pre>`;
      }
    }

    window.addEventListener("DOMContentLoaded", loadChart);
  </script>
</body>
</html>
